
@{
    Layout = "~/Views/Shared/_Mobile.cshtml";
}
@{
    ViewBag.Title = ViewData["title"];
}
@{
    string time = "";
}
<!--<div style="background:#FFF;z-index:99;top:0;left:0;width:100%;height:32px;line-height:32px;text-align:center;position: fixed;" id="xxeee">
        </div>-->
<!-- $.waiting()（START） -->
<div class="rotatedivwrapper">
    <div class="rotatediv"></div>
    <div class="msg"></div>
</div>
<!-- $.waiting()（END） -->

<style>
</style>
<div class="p0901-p3" style="padding-bottom:0;">
    <div class="p0901-p5">
        请确认时间和金额
    </div>
</div>

<div class="blackrowgall nmt unclickable">
    <div class="row">
        <span class="tt">驾校</span>
        <div class="holder">
            <span>@(((System.Collections.Hashtable)ViewData["item"])["SchoolText"])</span>
        </div>
    </div>
    <div class="row height">
        <span class="tt">时间</span>
    </div>
    <div class="row">
        <div class="p1001-p1">
            <div class="bold td">@(((System.Collections.Hashtable)ViewData["item"])["RunDate"])</div>
            <div class="blue td col2">
                @if ((((System.Collections.Hashtable)ViewData["item"])["Time"]) != null)
                {
                    time = (((System.Collections.Hashtable)ViewData["item"])["Time"]).ToString();

                    string[] str_time = time.Split(',');

                    Array.Sort(str_time);

                    foreach (string t in str_time)
                    {
                        int tmp = Convert.ToInt32(t);
                        int tmp1 = tmp - 1;

                        <div>@tmp1.ToString():00 ~ @tmp.ToString():00</div>

                    }
                }
                @*<div>12:00 ~ 13:00</div>
                <div>15:00 ~ 16:00</div>
                <div>17:00 ~ 18:00</div>*@
            </div>
        </div>
    </div>
</div>

<div class="blackrowgall tran unclickable">
    <div class="row">
        <span class="tt lightgray">总金额</span>
        <div class="holder">
            <span>￥<span id="amount">@(((System.Collections.Hashtable)ViewData["item"])["Amount"])</span>元</span>
        </div>
    </div>
    <div class="row" style="display:none">
        <span class="tt lightgray">账户余额</span>
        <div class="holder">
            <span>100</span><span class="lijian-bpe">（减）</span>
        </div>
    </div>
    <div class="row">
        <span class="tt lightgray">学时卷</span>
        <div class="holder">
            <select id="coupon-list">                
                <option value="0">不使用学时卷</option>
                @foreach (var item in ViewData["list"] as List<System.Collections.Hashtable>)
                {
                    string expire = item["Expire"].ToString();

                    if (expire == "" || expire == "null")
                    {
                        continue;
                    }

                    <option value="@item["CouponID"]">学时券 x 1（@DateTime.Parse(expire).ToString("MM月dd日") 到期）</option>
                    @*<option>200（5月18日到期）</option>*@
                }
                
            </select><span class="lijian-bpe">（减）</span>
        </div>
    </div>
    <div class="row">
        <span class="tt">付款</span>
        <div class="holder">
            <span>￥<span id="pay-amount" time="@time">@(((System.Collections.Hashtable)ViewData["item"])["PayAmount"])</span>元</span>
        </div>
    </div>
</div>

<div class="clear-15"></div>
<a href="javascript:void(0)" class="fullbtn pay"><i class="fa fa-wechat"></i> 微信支付</a>
<div class="clear-15"></div>
<a href="/home/myorder" class="fullbtn normal">返回</a>

<div class="bt-distance"></div>
<script type="text/javascript">
    var orderid = '@ViewData["orderid"]';
    var openid = '@ViewData["openid"]';

    $(document).ready(function () {
        $('.pay').click(function () {
            updatePayAmount();
        })

        $('#coupon-list').change(function () {
            if ($(this).val() == '0') {
                $('#pay-amount').html($('#amount').html());
            }
            else {
                var times = $('#pay-amount').attr('time');
                var amount = parseInt($('#amount').html());
                var hours = times.split(',').length;
                var price = amount / hours;
                var payAmount = price * (hours - 1);


                $('#pay-amount').html(payAmount);
            }
        })
    })

    function updatePayAmount() {
        if ($('#pay-amount').html() == $('#amount').html()) {
            pay();

            return;
        }

        var payAmount = $('#pay-amount').html();
        var couponId = $('#coupon-list').val();

        //alert(time);
        var data = { 'orderid': orderid, 'couponid': couponId, 'payamount': payAmount };
        //alert(JSON.stringify(data));
        var params = {
            url: '/api/order/UpdateAmount',
            data: data,
            successFun: successCoupon,
            errorFun: errorCoupon
        }

        ajaxTo(params);

        return true;
    }

    function successCoupon(data) {
        if (data.code == "200") {
            pay();
        }
        else {
            var opertion = {
                msg: data.message,
                exitText: "关闭!"
            };

            $.alertbox(opertion);
        }
    }

    function errorCoupon() {
        var opertion = {
            msg: "使用优惠卷失败!",
            exitText: "关闭!"
        };

        $.alertbox(opertion);
    }

    function pay() {
        var url = ''
        var amount = $('#pay-amount').html().replace('.00','');
       
        if (amount == '0' || amount == '0.00') {
            var opertion = {
                msg: '支付金额必须大于0元',
                exitText: "关闭!"
            };

            $.alertbox(opertion);

            return;
        }
        //测试链接
        //url = '/home/paysuccess/' + orderid;
	    url = '/home/orderpay?openid=' + openid + '&total_fee=' + amount + '&orderid=' + orderid;

        location.href = url;
    }
</script>