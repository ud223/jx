<!DOCTYPE html>
<html>

<head>
  {:W('Page/pageMeta')}

  {:W('Page/pageTitle')}

  {:W('Page/pageHeadInclude')}
  
</head>

<body {:W('Page/bodyCss')}>

<div class="wrapper wrapper-content animated fadeIn">
  <!--主体内容 Begin-->
  <div class="row">
    <div class="col-sm-12">
      <div class="ibox float-e-margins">
        <div class="ibox-title">
          <h5>发起预约</h5>
        </div>

        <div class="ibox-content">
          <form class="form-horizontal" id="addForm" action="__URL__/SubscribeOrderInfoSave" method="post">
            <input type="hidden" name="order_sn" id="order_sn" value="{$OrderInfo.order_sn}" />

            <div class="form-group">
              <div class="col-sm-12 col-sm-offset-3">
                <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i>&nbsp;保存</button>
                <button class="btn btn-white" type="button" onclick="BackIndexPage();"><i class="fa fa-mail-reply"></i>&nbsp;取消并返回</button>
                <button class="btn btn-success" type="button" onclick="f5();"><i class="fa fa-refresh"></i>&nbsp;刷新页面</button>
              </div>
            </div>

            <div class="hr-line-dashed"></div>

            <!--团队长 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                <span class="label label-info">必填</span> 团队长
              </label>
              <div class="col-sm-4">
                <notempty name="SellerCaptainOption">
                  <select class="chosen-select" name="seller_captain_id" id="seller_captain_id" data-placeholder="请选择团队长" style="width: 100% !important;" onchange="SetSellerMemberOption(this);">
                    <option value="">请选择团队长</option>
                    <volist name="SellerCaptainOption" id="list">
                      <option value="{$list.val}" <eq name="list.val" value="$OrderInfo.seller_captain_id">selected</eq> >{$list.key}</option>
                    </volist>
                  </select>
                <else/>
                  <p class="form-control-static">{$SellerCaptainInfo.real_name}</p>
                  <input type="hidden" name="seller_captain_id" id="seller_captain_id" value="{$SellerCaptainInfo.id}" />
                </notempty>
              </div>
            </div>
            <!--团队长 End-->

            <div class="hr-line-dashed"></div>
  
            <!--客户经理 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                客户经理
              </label>

              <div class="col-sm-4">
                <if condition="($AccountType eq $AdminAccount) OR ($AccountType eq $BrokerCompanyAccountType) OR ($AccountType eq $SellerCaptainAccountType) ">
                  <select class="chosen-select" name="seller_member_id" id="seller_member_id" data-placeholder="请选择客户经理" style="width: 100% !important;" onchange="LoadCustomerOption(this);">
                    <option value="">--</option>
                    <volist name="SellerMemberOption" id="list">
                      <option value="{$list.val}" <eq name="list.val" value="$OrderInfo.seller_member_id">selected</eq> >{$list.key}</option>
                    </volist>
                  </select>
                  <else/>
                  <p class="form-control-static">{$SellerMemberInfo.real_name}</p>
                  <input type="hidden" name="seller_member_id" id="seller_member_id" value="{$SellerMemberInfo.id}" />
                </if>
              </div>
            </div>
            <!--客户经理 End-->
  
            <div class="hr-line-dashed"></div>
  
            <!--选择计划书 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                
              </label>
    
              <div class="col-sm-7">
                <button class="btn btn-primary" type="button" onclick="GetPlanList();">
                  <i class="fa fa-dot-circle-o"></i>&nbsp;从保险计划书中读取客户数据（不包括已拒绝的）
                </button>
              </div>
            </div>
            <!--选择计划书 End-->

            <div class="hr-line-dashed"></div>
  
            <!--客户 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                <span class="label label-info">必填</span> 客户
              </label>
              <div class="col-sm-4">
                <select class="chosen-select" name="customer" id="customer" data-placeholder="请选择客户" style="width: 100% !important;" onchange="LoadCustomerInfo();">
                  <option value="">--</option>
                  <volist name="CustomerOption" id="list">
                    <option value="{$list.val}" <eq name="list.val" value="$OrderInfo.customer_id">selected</eq> >{$list.key}</option>
                  </volist>
                </select>
              </div>
              <div class="col-sm-4">
                <button type="button" class="btn btn-primary" onclick="GetCustomerAboutData();"><i class="fa fa-user-plus"></i>&nbsp;添加新客户</button>
              </div>
            </div>

            <div class="form-group" id="customer_info_ifr" <empty name="CustomerInfo">style="display: none;"</empty>>
              <label class="col-sm-3 control-label"></label>
              <div class="col-sm-9" id="customer_content_ifr">
                <p class="form-control-static">
                  <label class="label label-info">姓名：<span class="label label-default">{$CustomerInfo.real_name}</span></label>&nbsp;
                  <label class="label label-info">性别：<span class="label label-default">{$CustomerInfo.gender}</span></label>&nbsp;
                  <label class="label label-info">国籍：<span class="label label-default">{$CustomerInfo.nationality}</span></label>&nbsp;
                </p>
                <p class="form-control-static">
                  <label class="label label-info">证件类型：<span class="label label-default">{$CustomerInfo.idcard_type}</span></label>&nbsp;
                  <label class="label label-info">证件号：<span class="label label-default">{$CustomerInfo.idcard_no}</span></label>&nbsp;
                  <label class="label label-info">证件照片：<span class="label label-default">{$CustomerInfo.idcard_img_a.original_name}</span></label>&nbsp;
                </p>
                <p class="form-control-static">
                  <label class="label label-info">联系电话：<span class="label label-default">{$CustomerInfo.phone}</span></label>&nbsp;
                </p>
              </div>
            </div>
            <!--客户 End-->
        
            <div class="hr-line-dashed"></div>
        
            <!--预约时间 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                <span class="label label-info">必填</span> 预约时间
              </label>
              <div class="col-sm-7">
                <input type="text" autocomplete="off" name="reservation_time" id="reservation_time" class="form-control layer-date" placeholder="预约时间" onfocus="laydate({istime: true, format: 'YYYY-MM-DD hh:mm'});" value="{$OrderInfo.reservation_time}">
              </div>
            </div>
            <!--预约时间 End-->
        
            <div class="hr-line-dashed"></div>
  
            <!--拟购产品 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                拟购产品
              </label>
              <div class="col-sm-3">
                <select class="chosen-select" name="service_providers" id="service_providers" data-placeholder="请选择产品类型" style="width: 100% !important;" onchange="LoadProductOptionList(this);">
                  <option value="">请选择产品类型</option>
                  <volist name="ProductTypeOption" id="list">
                    <option value="{$list.val}" <eq name="list.val" value="$ProductInfo.type_id">selected</eq> >{$list.key}</option>
                  </volist>
                </select>
              </div>
              <div class="col-sm-3">
                <select class="chosen-select" name="product" id="product" data-placeholder="请选择产品" style="width: 100% !important;" onchange="LoadProductInfo(this);">
                  <option value="">请选择产品</option>
                  <volist name="ProductOption" id="list">
                    <option value="{$list.val}" <eq name="list.val" value="$ProductInfo.product_id">selected</eq> >{$list.key}</option>
                  </volist>
                </select>
              </div>
            </div>
            <!--拟购产品 End-->
      
            <div class="hr-line-dashed"></div>
  
            <!--年缴保费 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                年缴保费
              </label>
              <div class="col-sm-7">
                <input type="text" name="year_premium_amount" id="year_premium_amount" class="form-control" placeholder="年缴保费" value="{$OrderInfo.year_premium_amount}">
              </div>
            </div>
            <!--年缴保费 End-->

            <div class="hr-line-dashed"></div>
  
            <!--缴费年限 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                缴费年限
              </label>
              <div class="col-sm-7">
                <input type="text" name="payment_years" id="payment_years" class="form-control" placeholder="缴费年限" value="{$OrderInfo.payment_years}">
              </div>
            </div>
            <!--缴费年限 End-->
        
            <div class="hr-line-dashed"></div>
  
            <!--保障额度 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                保障额度
              </label>
              <div class="col-sm-7">
                <input type="text" name="guarantee_amount" id="guarantee_amount" class="form-control" placeholder="保障额度" value="{$OrderInfo.guarantee_amount}">
              </div>
            </div>
            <!--保障额度 End-->
        
            <div class="hr-line-dashed"></div>
  
            <!--附件 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">
                附件
              </label>
              <div class="col-sm-7">
                <input type="file" name="attachment" id="attachment" class="form-control">
                <span class="help-block m-b-none">只能上传jpg、png格式的图片</span>
              </div>
            </div>

            <div id="div_attachment_ifr"></div>
            <notempty name="OrderInfo.attachment">
              <div class="form-group">
                <label class="col-sm-3 control-label"></label>
                <div class="col-sm-9">

                  <div class="file-box">
                    <div class="file">
                      <a href="__MODULE__/Download/OriginalNameFile/file_id/{$OrderInfo.attachment.id}">
                        <span class="corner"></span>

                        <div class="image">
                          <img alt="image" class="img-responsive" src="{$OrderInfo.attachment.full_file}">
                        </div>
                        <div class="file-name">
                          <span style="word-wrap:break-word;">{$OrderInfo.attachment.original_name}</span>
                          <br/>
                          <small>添加时间：{$OrderInfo.attachment.add_date}</small>
                        </div>
                      </a>
                    </div>
                  </div>

                </div>
              </div>
            </notempty>
            <!--附件 End-->

            <div class="hr-line-dashed"></div>
  
            <!--备注 Begin-->
            <div class="form-group">
              <label class="col-sm-3 control-label">客户经理备注</label>
              <div class="col-sm-7">
                <textarea class="form-control" name="seller_manager_remarks" id="seller_manager_remarks" rows="5" autocomplete="off" placeholder="客户经理备注" style="resize: none;">{$OrderInfo.seller_manager_remarks}</textarea>
              </div>
            </div>
            <!--备注 End-->
        
            <div class="hr-line-dashed"></div>

            <div class="form-group">
              <div class="col-sm-12 col-sm-offset-3">
                <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i>&nbsp;保存</button>
                <button class="btn btn-white" type="button" onclick="BackIndexPage();"><i class="fa fa-mail-reply"></i>&nbsp;取消并返回</button>
                <button class="btn btn-success" type="button" onclick="f5();"><i class="fa fa-refresh"></i>&nbsp;刷新页面</button>
              </div>
            </div>
          </form>
        </div>
        
      </div>
    </div>
  </div>
  <!--主体内容 End-->

  <!--添加客户Modal Begin-->
  <div class="modal inmodal fade" id="modal_add_customer_ifr" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg">
      <div class="modal-content animated fadeIn">
        <div class="modal-header">
          <h4 class="modal-title">添加客户</h4>
        </div>

        <form class="form-horizontal" id="addCustomerForm" action="__URL__/AjaxCustomerSave" method="post">
          <div class="modal-body">
            <input type="hidden" name="modal_seller_captain_id" id="modal_seller_captain_id" value="" />
            <input type="hidden" name="modal_seller_member_id" id="modal_seller_member_id" value="" />

            <div class="form-group">
              <label class="col-sm-3 control-label">
                <span class="label label-info">必填</span> 客户姓名
              </label>
              <div class="col-sm-7">
                <input type="text" autocomplete="off" name="real_name" id="real_name" class="form-control" placeholder="客户姓名" value="">
              </div>
            </div>

            <div class="hr-line-dashed"></div>

            <div class="form-group">
              <label class="col-sm-3 control-label">
                <span class="label label-info">必填</span> 国籍
              </label>
              <div class="col-sm-7">
                <input type="text" autocomplete="off" name="nationality" id="nationality" class="form-control" placeholder="国籍" value="">
              </div>
            </div>

            <div class="hr-line-dashed"></div>

            <div class="form-group">
              <label class="col-sm-3 control-label">
                <span class="label label-info">必填</span> 出生日期
              </label>
              <div class="col-sm-7">
                <input type="text" autocomplete="off" name="birthday" id="birthday" class="form-control layer-date" placeholder="出生日期" onfocus="laydate({istime: false, format: 'YYYY-MM-DD', start: '1980-01-01'});" value="">
              </div>
            </div>

            <div class="hr-line-dashed"></div>

            <div class="form-group">
              <label class="col-sm-3 control-label">
                <span class="label label-info">必填</span> 性别
              </label>
              <div class="col-sm-7" id="div_gender">

              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">保存</button>
            <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--添加客户Modal End-->

  <!--计划书列表Modal Begin-->
  <div class="modal inmodal fade" id="modal_plan_list_ifr" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg">
      <div class="modal-content animated fadeIn">
        <div class="modal-header">
          <h4 class="modal-title">保险计划书列表</h4>
        </div>
  
        <div class="modal-body">
          <table class="table table-hover">
            <thead>
            <tr>
              <th class="text-left">保险计划书编号</th>
              <th class="text-left">客户姓名</th>
              <th class="text-left">产品</th>
              <th>发起日期</th>
              <th class="text-center">当前状态</th>
              <th></th>
            </tr>
            </thead>
    
            <tbody id="plan_list_ifr"></tbody>
    
            <tfoot>
            <tr>
              <th class="text-left">保险计划书编号</th>
              <th class="text-left">客户姓名</th>
              <th class="text-left">产品</th>
              <th>发起日期</th>
              <th class="text-center">当前状态</th>
              <th></th>
            </tr>
            </tfoot>
          </table>
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>
  <!--计划书列表Modal End-->
</div>

{:W('Page/pageFootInclude')}

<script>
  var ReturnUrl = "__URL__/SubscribeOrderList";

  $(document).ready(function(){
    //region 下拉框样式
    var config = {
      ".chosen-select": {},
      ".chosen-select-deselect": {
        allow_single_deselect: !0
      },
      ".chosen-select-no-single": {
        disable_search_threshold: 10
      },
      ".chosen-select-no-results": {
        no_results_text: "Oops, nothing found!"
      },
      ".chosen-select-width": {
        width: "95%"
      }
    };

    for (var selector in config) $(selector).chosen(config[selector]);
    //endregion 下拉框样式

    //region 表单验证
    $("#addForm").validate({
      ignore: "",
      rules: {},
      messages: {},
      focusInvalid: true,
      submitHandler: function(form) {
        $(form).ajaxSubmit({
          timeout : 6000,    // 限制请求的时间，当请求大于6秒后，跳出请求
          type : "POST",
          dataType : "json",
          beforeSend : function (XMLHttpRequest) {
            XMLHttpRequest.setRequestHeader("request_type","ajax");
          },
          beforeSubmit : SubmitBefore,
          success : SubmitResponse,    // 提交后的回调函数
          error : SubmitError
        });
      }
    });
    //endregion 表单验证

    //region 添加客户表单验证
    $("#addCustomerForm").validate({
      ignore: "",
      rules: {
        broker_company : {
          required : true,
          min:1,
          number:true
        },
        real_name : {
          required : true
        },
        nationality : {
          required : true
        },
        birthday : {
          required : true
        },
      },
      messages: {
        broker_company : {
          required : "请选择经纪公司",
          min : "经纪公司不存在",
          number : "经纪公司不存在"
        },
        real_name : "请输入姓名",
        nationality : "请输入国籍",
      },
      focusInvalid: true,
      submitHandler: function(form) {
        $(form).ajaxSubmit({
          timeout : 6000,    // 限制请求的时间，当请求大于6秒后，跳出请求
          type : "POST",
          dataType : "json",
          beforeSend : function (XMLHttpRequest) {
            XMLHttpRequest.setRequestHeader("request_type","ajax");
          },
          beforeSubmit : SubmitCustomerBefore,
          success : SubmitCustomerResponse,    // 提交后的回调函数
          error : SubmitCustomerError
        });
      }
    });
    //endregion 添加客户表单验证
  });
  
  //region 提交表单
  function SubmitBefore(){
    BlockWindow_ExecOp('正在保存保险计划书数据', 140);
  }

  function SubmitResponse(responseText){
    Un_BlockWindow_ExecOp();

    if(responseText.error!=0){
      AlertError(responseText.info);
      return false;
    }

    swal(
      {
        title: "",
        text: responseText.info,
        type: "success",
        confirmButtonText: "确定",
        closeOnConfirm: true
      },
      function(isConfirm){
        <if condition="($AccountType neq $SellerManagerAccount)">
          window.parent.PollingUntreatedNumber();
        </if>

        BackIndexPage();
      }
    );
  }
  
  function SubmitError(){
    Un_BlockWindow_ExecOp();

    AlertError("请求超时");
    return false;
  }

  function SubmitCustomerBefore(){
    BlockWindow_ExecOp('正在保存客户数据', 140);
  }

  function SubmitCustomerResponse(responseText){
    Un_BlockWindow_ExecOp();

    if(responseText.error!=0){
      AlertError(responseText.info);
      return false;
    }else{
      if(IsN(responseText.data)){
        AlertError("未查询到添加的客户数据");
        return false;
      }
    }

    var CustomerInfo = responseText.data;
    $("#customer").find("option:selected").attr("selected", false);
    var sHtml = '<option value="'+ CustomerInfo.id +'" selected>'+ CustomerInfo.real_name +'</option>';
    $('#customer').append(sHtml).trigger("chosen:updated");

    LoadCustomerInfo();

    $('#customer').trigger("chosen:updated");

    HideAddCustomerModal();
    ClearAddCustomerInfo();
  }

  function SubmitCustomerError(){
    Un_BlockWindow_ExecOp();

    AlertError("请求超时");
    return false;
  }
  //endregion 提交表单

  //region 设置客户经理option
  function SetSellerMemberOption(obj) {
    var nSellerCaptainID = $(obj).val();

    if(IsN(nSellerCaptainID)){
      return false;
    }

    BlockWindow_ExecOp('正在获取客户经理数据', 180);

    $.ajax({
      type: "POST",
      url: "__URL__/AjaxGetSellerMemberOption",
      dataType:"json",
      data: {"seller_captain_id": nSellerCaptainID},
      timeout: 6000,
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        SetSellerMemberOptionResponse(data);
      },
      error: function(request, status, error){
        Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }

  function SetSellerMemberOptionResponse(objJson){
    Un_BlockWindow_ExecOp();

    if(objJson.error != 0){
      AlertError(objJson.info);
      return false;
    }

    if(IsN(objJson.data)){
      return false;
    }

    var Dom = [];
    var MemberList = objJson.data;
    var nLen = MemberList.length;
    var Info = null;

    Dom.push('<option value="">请选择客户经理</option>');

    for(var i=0; i<nLen; i++){
      Info = MemberList[i];

      Dom.push('<option value="'+Info.val+'">'+Info.key+'</option>');
    }

    $('#seller_member_id').html(Dom.join('')).trigger("chosen:updated");

    ClearCustomerOption(false);
  }
  //endregion 设置客户经理option

  //region 获取客户信息
  function ClearCustomerOption(changedesc) {
    $('#customer_content_ifr').html('');
    $('#customer_info_ifr').hide();

    if(changedesc){
      $('#customer').html('<option value="">请选择客户</option>').trigger("chosen:updated");
    }else{
      $('#customer').html('<option value="">--</option>').trigger("chosen:updated");
    }

  }

  function LoadCustomerOption(obj) {
    ClearCustomerOption(false);

    var nSellerCaptainId = $('#seller_captain_id').val();
    var nSellerMemberId = $(obj).val();

    if(IsN(nSellerMemberId) && IsN(nSellerCaptainId)){
      return false;
    }

    BlockWindow_ExecOp('正在获取客户信息', 180);

    $.ajax({
      type: "POST",
      url: "__URL__/AjaxGetCustomerOption",
      dataType:"json",
      data: {"seller_captain_id": nSellerCaptainId, "seller_member_id": nSellerMemberId},
      timeout: 6000,
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        LoadCustomerOptionResponse(data);
      },
      error: function(request, status, error){
        Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }

  function LoadCustomerOptionResponse(objJson) {
    Un_BlockWindow_ExecOp();

    if(objJson.error != 0){
      AlertError(objJson.info);
      return false;
    }

    if(IsN(objJson.data)){
      return false;
    }

    var Dom = [];
    var CustomerList = objJson.data;
    var nLen = CustomerList.length;
    var Info = null;

    Dom.push('<option value="">请选择客户</option>');

    for(var i=0; i<nLen; i++){
      Info = CustomerList[i];

      Dom.push('<option value="'+Info.val+'">'+Info.key+'</option>');
    }

    $('#customer').html(Dom.join('')).trigger("chosen:updated");
  }

  function LoadCustomerInfo(){
    var objCustomer = $('#customer');
    var nCustomerID = objCustomer.val();

    if(IsN(nCustomerID)){
      $('#customer_content_ifr').html('');
      $('#customer_info_ifr').fadeOut('fast');
      return false;
    }

    BlockWindow_ExecOp('获取产品信息', 140);

    $.ajax({
      type: "POST",
      url: "__URL__/AjaxCustomerInfo",
      dataType:"json",
      data: {"customer_id": nCustomerID},
      timeout: 6000,
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        LoadCustomerInfoResponse(data);
      },
      error: function(request, status, error){
        Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }

  function LoadCustomerInfoResponse(objJson){
    Un_BlockWindow_ExecOp();

    if(objJson.error != 0){
      $('#customer_content_ifr').html('');
      $('#customer_info_ifr').fadeOut('fast');

      AlertError(objJson.info);
      return false;
    }

    //region 产品列表
    var Dom = [];
    var CustomerInfo = objJson.data;

    Dom.push('<p class="form-control-static">');
    Dom.push('<label class="label label-info">客户编号：<span class="label label-default">'+ CustomerInfo.id +'</span></label>&nbsp;');
    Dom.push('<label class="label label-info">姓名：<span class="label label-default">'+ CustomerInfo.real_name +'</label>&nbsp;');
    Dom.push('<label class="label label-info">性别：<span class="label label-default">'+ CustomerInfo.gender +'</label>&nbsp;');
    Dom.push('<label class="label label-info">国籍：<span class="label label-default">'+ CustomerInfo.nationality +'</label>&nbsp;');
    Dom.push('</p>');
//    Dom.push('<p class="form-control-static">');
//    Dom.push('<label class="label label-info">证件类型：<span class="label label-default">'+ CustomerInfo.idcard_type +'</span></label>&nbsp;');
//    Dom.push('<label class="label label-info">证件号：<span class="label label-default">'+ CustomerInfo.idcard_no +'</span></label>&nbsp;');
//    Dom.push('<label class="label label-info">证件照片：<span class="label label-default">'+ CustomerInfo.idcard_img_a.original_name +'</span></label>&nbsp;');
//    Dom.push('</p>');
//    Dom.push('<p class="form-control-static">');
//    Dom.push('<label class="label label-info">联系电话：<span class="label label-default">'+ CustomerInfo.phone +'</span></label>&nbsp;');
//    Dom.push('</p>');

    $('#customer_content_ifr').html(Dom.join(''));
    $('#customer_info_ifr').fadeIn();
    //endregion 产品列表
  }
  //endregion 获取客户信息

  //region 获取产品列表
  function LoadProductOptionList(obj, type_id, product_id){
    var nProductTypeID = null;
    
    if(!IsN(obj)){
      nProductTypeID = $(obj).val();
    }else{
      nProductTypeID = type_id;
    }
    
    if(IsN(nProductTypeID)){
      var sKey = $('#product').attr("data-placeholder");
      $('#product').html('<option value="">'+ sKey +'</option>').trigger("chosen:updated");;
      return false;
    }

    BlockWindow_ExecOp('正在获取产品列表', 140);

    $.ajax({
      type: "POST",
      url: "__URL__/AjaxProductOptionList",
      dataType:"json",
      data: {"product_type_id": nProductTypeID},
      timeout: 6000,
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        LoadProductOptionListResponse(data, product_id);
      },
      error: function(request, status, error){
        Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }

  function LoadProductOptionListResponse(objJson, product_id){
    Un_BlockWindow_ExecOp();
    
    if(objJson.error != 0){
      AlertError(objJson.info);
      return false;
    }

    var sKey = $('#product').attr("data-placeholder");
    if(IsN(objJson.data)){
      $('#product').html('<option value="">'+ sKey +'</option>').trigger("chosen:updated");;

      return false;
    }

    //region 产品列表
    var Dom = [];
    var OptionList = objJson.data;
    var nLen = OptionList.length;
    var Info = null;

    Dom.push('<option value="">'+ sKey +'</option>');

    for(var i=0; i<nLen; i++){
      Info = OptionList[i];

      Dom.push('<option value="'+Info.val+'">'+Info.key+'</option>');
    }

    $('#product').html(Dom.join('')).trigger("chosen:updated");
    
    if(!IsN(product_id)){
      $('#product').val(product_id).trigger("chosen:updated");
    }
    //endregion 产品列表
  }
  //endregion 获取产品列表
  
  //region 获取产品信息
  function LoadProductInfo(obj){
    var nProductID = $(obj).val();

    if(IsN(nProductID)){
      $('#product_content_ifr').html('');
      $('#product_info_ifr').fadeOut('fast');
      return false;
    }

    BlockWindow_ExecOp('获取产品信息', 140);

    $.ajax({
      type: "POST",
      url: "__URL__/AjaxProductInfo",
      dataType:"json",
      data: {"product_id": nProductID},
      timeout: 6000,
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        LoadProductInfoResponse(data);
      },
      error: function(request, status, error){
        Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }

  function LoadProductInfoResponse(objJson){
    Un_BlockWindow_ExecOp();

    if(objJson.error != 0){
      $('#product_content_ifr').html('');
      $('#product_info_ifr').fadeOut('fast');
      
      AlertError(objJson.info);
      return false;
    }

    var sKey = $('#product').attr("data-placeholder");
    if(IsN(objJson.data)){
      $('#product').html('<option value="">'+ sKey +'</option>').trigger("chosen:updated");;

      return false;
    }

    //region 产品列表
    var Dom = [];
    var ProductInfo = objJson.data;

    Dom.push('<p class="form-control-static">');
    Dom.push('<label class="label label-info">产品编号：<span class="label label-default">'+ ProductInfo.id +'</span></label>&nbsp;');
    Dom.push('<label class="label label-info">产品名称：<span class="label label-default">'+ ProductInfo.product_name +'</span></label>&nbsp;');
    Dom.push('<label class="label label-info">产品价格：<span class="label label-default"><i class="fa fa-cny"></i>'+ ProductInfo.product_price +'</span></label>&nbsp;');
    Dom.push('</p>');
    Dom.push('<p class="form-control-static">');
    Dom.push('<label class="label label-info">产品简介：<span class="label label-default">'+ ProductInfo.intro +'</span></label>&nbsp;');
    Dom.push('</p>');
    Dom.push('<p class="form-control-static">');
    Dom.push('<label class="label label-info">产品备注：<span class="label label-default">'+ ProductInfo.remarks +'</span></label>&nbsp;');
    Dom.push('</p>');

    $('#product_content_ifr').html(Dom.join(''));
    $('#product_info_ifr').fadeIn();
    //endregion 产品列表
  }
  //endregion 获取产品信息

  //region 添加客户
  function GetCustomerAboutData() {
    var nCaptainID = $('#seller_captain_id').val();
    var nMemberID = $('#seller_member_id').val();

    if(IsN(nCaptainID)){
      AlertError("请指定团队长");
      return false;
    }

    if(IsN(nMemberID)){
      AlertError("请指定客户经理");
      return false;
    }

    $('#modal_seller_captain_id').val(nCaptainID);
    $('#modal_seller_member_id').val(nMemberID);

    BlockWindow_ExecOp('正在获取客户相关', 140);

    $.ajax({
      type: "POST",
      url: "__URL__/AjaxCustomerAboutData",
      dataType:"json",
      timeout: 6000,
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        GetCustomerAboutDataResponse(data);
      },
      error: function(request, status, error){
        Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }

  function GetCustomerAboutDataResponse(objJson) {
    Un_BlockWindow_ExecOp();

    if(objJson.error != 0){
      AlertError(objJson.info);
      return false;
    }else{
      if(IsN(objJson.data)){
        AlertError("没有查询到客户相关数据");
        return false;
      }
    }

    var Dom = [];
    var nLen = 0;
    var Info = null;

    //region 加载性别
    var GenderOption = objJson.data.GenderOption;

    if(!IsN(GenderOption)){
      Dom = [];
      nLen = GenderOption.length;

      for(var i=0; i<nLen; i++){
        Info = GenderOption[i];

        Dom.push('<div class="radio radio-inline radio-info">');
        Dom.push('<input type="radio" id="gender_'+ Info.val +'" name="gender" value="'+ Info.key +'"');

        if(i==0){
          Dom.push(' checked ');
        }
        Dom.push('>');
        Dom.push('<label for="gender_'+ Info.val +'"> '+ Info.key +' </label>');
        Dom.push('</div>');
      }

      $('#div_gender').html(Dom.join(''));
    }

    //endregion 加载性别

    ShowAddCustomerModal();
  }

  function ShowAddCustomerModal() {
    $('#modal_add_customer_ifr').modal();
  }

  function HideAddCustomerModal() {
    $('#modal_add_customer_ifr').modal('hide');
  }

  function ClearAddCustomerInfo() {
    $('#modal_seller_captain_id').val('');
    $('#modal_seller_member_id').val('');
    $('#real_name').val('');
    $('#nationality').val('');
    $('#birthday').val('');
  }
  //endregion 添加客户

  //region 获取计划书列表
  function GetPlanList(){
    BlockWindow_ExecOp('正在获取计划书列表', 180);
  
    $.ajax({
      type: "POST",
      url: "__URL__/AjaxPlanList",
      dataType:"json",
      timeout: 6000,
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        GetPlanListResponse(data);
      },
      error: function(request, status, error){
        Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }
  
  function GetPlanListResponse(objJson) {
    Un_BlockWindow_ExecOp();
    
    if(objJson.error != 0){
      AlertError(objJson.info);
      return false;
    }else{
      if(IsN(objJson.data)){
        ShowPlanListModal();
        return false;
      }
    }
    
    var PlanList = objJson.data;
    var nLen = PlanList.length;
    var Dom = [];
    var Info = null;
    
    for(var i=0; i<nLen; i++){
      Info = PlanList[i];
      
      Dom.push('<tr>');
      Dom.push('<td class="text-left">'+ Info.order_sn +'</td>');
      Dom.push('<td class="text-left">'+ Info.customer.real_name +'</td>');
      Dom.push('<td class="text-left">'+ Info.product_snapshots.type_name +' - '+ Info.product_snapshots.product_name +'</td>');
      Dom.push('<td>'+ Info.signed_date +'</td>');
      Dom.push('<td class="text-center">');
      Dom.push('<p class="form-control-static">'+ Info.status_info.desc_style +'</p>');
      Dom.push('</td>');
      Dom.push('<td class="text-right">');
      Dom.push('<button class="btn btn-info" type="button"');
      Dom.push(' data-sn="'+ Info.order_sn +'"');
      Dom.push(' data-payment-years="'+ Info.payment_years +'"');
      Dom.push(' data-guarantee-amount="'+ Info.guarantee_amount +'"');
      Dom.push(' data-year-premium-amount="'+ Info.year_premium_amount +'"');
      Dom.push(' data-customer-id="'+ Info.customer_id +'"');
      Dom.push(' data-customer-name="'+ Info.customer.real_name +'"');
      Dom.push(' data-customer-gender="'+ Info.customer.gender +'"');
      Dom.push(' data-customer-nationality="'+ Info.customer.nationality +'"');
      Dom.push(' data-product-type-id="'+ Info.product_snapshots.type_id +'"');
      Dom.push(' data-product-id="'+ Info.product_snapshots.product_id +'"');
      Dom.push(' data-attachment-id="'+ Info.attachment.id +'"');
      Dom.push(' data-attachment-name="'+ Info.attachment.original_name +'"');
      Dom.push(' data-attachment-add-date="'+ Info.attachment.add_date +'"');
      Dom.push(' data-attachment-full-file="'+ Info.attachment.full_file +'"');
      Dom.push(' data-remark="'+ Info.seller_manager_remarks +'"');
      Dom.push(' onclick="SelectPlan(this);"><i class="fa fa-dot-circle-o"></i>&nbsp;选择</button>');
      Dom.push('</td>');
      Dom.push('</tr>');
    }
    
    $('#plan_list_ifr').html(Dom.join(''));
  
    ShowPlanListModal();
  }
  
  function SelectPlan(obj) {
    var sOrderSn = $(obj).attr('data-sn');
    var nPaymentYears = $(obj).attr('data-payment-years');
    var nGuaranteeAmount = $(obj).attr('data-guarantee-amount');
    var nYearPremiumAmount = $(obj).attr('data-year-premium-amount');
    var nCustomerID = $(obj).attr('data-customer-id');
    var sCustomerName = $(obj).attr('data-customer-name');
    var sCustomerGender = $(obj).attr('data-customer-gender');
    var sCustomerNationality = $(obj).attr('data-customer-nationality');
    var nProductTypeID = $(obj).attr('data-product-type-id');
    var nProductID = $(obj).attr('data-product-id');
    var nAttachmentID = $(obj).attr('data-attachment-id');
    var sAttachmentName = $(obj).attr('data-attachment-name');
    var nAttachmentAddDate = $(obj).attr('data-attachment-add-date');
    var sAttachmentFullFile = $(obj).attr('data-attachment-full-file');
    var sRemark = $(obj).attr('data-remark');
    
    //region 设置预约编号
    $('#order_sn').val(sOrderSn);
    //endregion 设置预约编号
    
    //region 设置客户信息
    $("#customer").val(nCustomerID).trigger("chosen:updated");
  
    var CustomerDom = [];
  
    CustomerDom.push('<p class="form-control-static">');
    CustomerDom.push('<label class="label label-info">客户编号：<span class="label label-default">'+ nCustomerID +'</span></label>&nbsp;');
    CustomerDom.push('<label class="label label-info">姓名：<span class="label label-default">'+ sCustomerName +'</label>&nbsp;');
    CustomerDom.push('<label class="label label-info">性别：<span class="label label-default">'+ sCustomerGender +'</label>&nbsp;');
    CustomerDom.push('<label class="label label-info">国籍：<span class="label label-default">'+ sCustomerNationality +'</label>&nbsp;');
    CustomerDom.push('</p>');
    
    $('#customer_content_ifr').html(CustomerDom.join(''));
    $('#customer_info_ifr').fadeIn();
    //endregion 设置客户信息
    
    //region 设置产品
    $('#service_providers').val(nProductTypeID).trigger("chosen:updated");
    LoadProductOptionList(null, nProductTypeID, nProductID);
    //endregion 设置产品
    
    //region 设置附件
    
    if(IsN(nAttachmentID) === true){
      var AttachmentDom = [];

      AttachmentDom.push('<div class="form-group">');
      AttachmentDom.push('<label class="col-sm-3 control-label"></label>');
      AttachmentDom.push('<div class="col-sm-9">');
      AttachmentDom.push('<div class="file-box">');
      AttachmentDom.push('<div class="file">');
      AttachmentDom.push('<a href="__MODULE__/Download/OriginalNameImage/image_id/'+ nAttachmentID +'">');
      AttachmentDom.push('<span class="corner"></span>');
      AttachmentDom.push('<div class="image">');
      AttachmentDom.push('<img alt="image" class="img-responsive" src="'+ sAttachmentFullFile +'">');
      AttachmentDom.push('</div>');
      AttachmentDom.push('<div class="file-name">');
      AttachmentDom.push('<span style="word-wrap:break-word;">'+ sAttachmentName +'</span>');
      AttachmentDom.push('<br/>');
      AttachmentDom.push('<small>添加时间：'+ nAttachmentAddDate +'</small>');
      AttachmentDom.push('</div>');
      AttachmentDom.push('</a>');
      AttachmentDom.push('</div>');
      AttachmentDom.push('</div>');
      AttachmentDom.push('</div>');
      AttachmentDom.push('</div>');
      
      $('#div_attachment_ifr').html(AttachmentDom.join(''));
    }
    //endregion 设置附件
    
    //region 设置备注
    $('#seller_manager_remarks').val(sRemark);
    //endregion 设置备注
    
    //region 设置缴费年限
    $('#payment_years').val(nPaymentYears);
    //endregion 设置缴费年限
  
    //region 设置保障额度
    $('#guarantee_amount').val(nGuaranteeAmount);
    //endregion 设置保障额度
  
    //region 设置年缴保费
    $('#year_premium_amount').val(nYearPremiumAmount);
    //endregion 设置年缴保费
  
    HidePlanListModal();
  }
  
  function ShowPlanListModal() {
    $('#modal_plan_list_ifr').modal();
  }

  function HidePlanListModal() {
    $('#modal_plan_list_ifr').modal('hide');
  }
  //endregion 获取计划书列表

  function BackIndexPage(){
    window.location.href = ReturnUrl;
  }
</script>
</body>

</html>