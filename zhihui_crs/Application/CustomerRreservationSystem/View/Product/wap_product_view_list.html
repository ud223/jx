<!DOCTYPE html>
<html lang="en">

<head>
  {:W('Page/wapPageMeta')}
  
  {:W('Page/wapPageTitle')}
  
  {:W('Page/wapPageHeadInclude')}
  
  <style>
    .mui-table-view{margin-top: 45px !important;}
    .mui-views,
    .mui-view,
    .mui-pages,
    .mui-page,
    .mui-page-content {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      background-color: #efeff4;
    }
    
    .mui-pages {
      /*top: 46px;*/
      height: auto;
    }
    
    .mui-page.mui-transitioning {
      -webkit-transition: -webkit-transform 300ms ease;
      transition: transform 300ms ease;
    }
    
    .mui-page-left {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }
    
    .mui-ios .mui-page-left {
      -webkit-transform: translate3d(-20%, 0, 0);
      transform: translate3d(-20%, 0, 0);
    }
    
    .mui-navbar {
      position: fixed;
      right: 0;
      left: 0;
      z-index: 10;
      height: 44px;
      background-color: #f7f7f8;
    }
    
    .mui-navbar .mui-bar {
      position: absolute;
      background: transparent;
      text-align: center;
    }
    
    .mui-android .mui-navbar-inner.mui-navbar-left {
      opacity: 0;
    }
    
    .mui-ios .mui-navbar-left .mui-left,
    .mui-ios .mui-navbar-left .mui-center,
    .mui-ios .mui-navbar-left .mui-right {
      opacity: 0;
    }
    
    .mui-navbar .mui-btn-nav {
      -webkit-transition: none;
      transition: none;
      -webkit-transition-duration: .0s;
      transition-duration: .0s;
    }
    
    .mui-navbar .mui-bar .mui-title {
      display: inline-block;
      width: auto;
    }
    
    .mui-page-shadow {
      position: absolute;
      right: 100%;
      top: 0;
      width: 16px;
      height: 100%;
      z-index: -1;
      content: '';
    }
    
    .mui-page-shadow {
      background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
      background: linear-gradient(to right, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
    }
    
    .mui-navbar-inner.mui-transitioning,
    .mui-navbar-inner .mui-transitioning {
      -webkit-transition: opacity 300ms ease, -webkit-transform 300ms ease;
      transition: opacity 300ms ease, transform 300ms ease;
    }
    
    .mui-page {
      display: none;
    }
    
    .mui-pages .mui-page {
      display: block;
    }
    
    .mui-page .mui-table-view:first-child {
      margin-top: 15px;
    }
    
    .mui-page .mui-table-view:last-child {
      margin-bottom: 30px;
    }
    
    .mui-table-view {
      margin-top: 20px;
    }
    
    .head-img {
      width: 40px;
      height: 40px;
    }
    
    .mui-fullscreen {
      position: fixed;
      /*z-index: 20;*/
      /*background-color: #000;*/
    }
    
    .mui-ios .mui-navbar .mui-bar .mui-title {
      position: static;
    }
  </style>
</head>

<body>
<!--页面主结构开始-->
<div id="app" class="mui-views mui-fullscreen mui-control-content mui-active">
  <div class="mui-view">
    <div class="mui-navbar"></div>
    <div class="mui-pages"></div>
  </div>
</div>
<!--页面主结构结束-->

<!--单页面开始-->
<div id="setting" class="mui-page">
  <!--页面标题栏开始-->
  <div class="mui-navbar-inner mui-bar mui-bar-nav">
    <h1 class="mui-center mui-title">产品浏览</h1>
  </div>
  <!--页面标题栏结束-->
  
  <!--页面主内容区开始-->
  <div class="mui-content mui-scroll-wrapper" id="product_list_ifr">
    <div class="mui-scroll">
      <ul class="mui-table-view mui-table-view-striped mui-table-view-condensed" id="ul_product_list">
      
      </ul>
    </div>
  </div>
  <!--页面主内容区结束-->
</div>
<!--单页面结束-->

<div id="account" class="mui-page">
  <div class="mui-navbar-inner mui-bar mui-bar-nav">
    <button type="button" class=" mui-navbar-left mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
      <span class="mui-icon mui-icon-left-nav"></span>
    </button>
    <h1 class="mui-center mui-title">产品详情</h1>
  </div>
  <div class="mui-page-content">
    <div class="mui-scroll-wrapper" id="product_info_ifr">
      <div class="mui-scroll">
        <ul class="mui-table-view">
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">产品类别</div>
              <div class="mui-col-xs-8 mui-h5" id="p_category_name"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">产品名称</div>
              <div class="mui-col-xs-8 mui-h5" id="p_product_name"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">缴费方式</div>
              <div class="mui-col-xs-8 mui-h5" id="p_pay_type"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">付款方式</div>
              <div class="mui-col-xs-8 mui-h5" id="p_payment_type"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">投保年龄</div>
              <div class="mui-col-xs-8 mui-h5" id="p_min_age"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">保险期间</div>
              <div class="mui-col-xs-8 mui-h5" id="p_validity_year"></div>
            </div>
          </li>
          <li class="mui-table-view-cell" id="li_captain_first_rate_ifr" style="display: none;">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">团队长首年提成比例</div>
              <div class="mui-col-xs-8 mui-h5" id="p_captain_first_rate"></div>
            </div>
          </li>
          <li class="mui-table-view-cell" id="li_captain_next_rate_ifr" style="display: none;">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">团队长次年提成比例</div>
              <div class="mui-col-xs-8 mui-h5" id="p_captain_next_rate"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">客户经理首年提成比例</div>
              <div class="mui-col-xs-8 mui-h5" id="p_member_first_rate"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">客户经理次年提成比例</div>
              <div class="mui-col-xs-8 mui-h5" id="p_member_next_rate"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">产品状态</div>
              <div class="mui-col-xs-8 mui-h5" id="p_product_status"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">产品简介</div>
              <div class="mui-col-xs-8 mui-h5" id="p_product_intro"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">产品详情</div>
              <div class="mui-col-xs-8 mui-h5" id="div_product_desc"></div>
            </div>
          </li>
          <li class="mui-table-view-cell">
            <div class="mui-row">
              <div class="mui-col-xs-4 mui-h5">备注</div>
              <div class="mui-col-xs-8 mui-h5" id="p_product_remark"></div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

{:W('Page/wapPageFootInclude')}
</body>

</html>
<script>
  var nCurrPage = 1;
  
  mui.init({
    pullRefresh : {
      container: '#product_list_ifr',//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
      up : {
        height:50,//可选.默认50.触发上拉加载拖动距离
        auto:true,//可选,默认false.自动上拉加载一次
        contentrefresh : "正在加载...",//可选，正在加载状态时，上拉加载控件上显示的标题内容
        contentnomore:'没有更多数据了',//可选，请求完毕若没有更多数据时显示的提醒内容；
        callback : GetNextPageProductList //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
      }
    }
  });
  
  //region 获取下一页产品
  function GetNextPageProductList() {
    $.ajax({
      type: "POST",
      url: "__URL__/AjaxProductViewList",
      dataType:"json",
      timeout: 6000,
      data: {"page": nCurrPage},
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        GetNextPageProductListResponse(data);
      },
      error: function(request, status, error){
        mui.toast("请求服务器时发生错误");
        mui('#product_list_ifr').pullRefresh().endPullupToRefresh(false);
      }
    });
  }
  
  function GetNextPageProductListResponse(objJson) {
    if(objJson.error != 0){
      mui.toast(objJson.info);
      mui('#product_list_ifr').pullRefresh().endPullupToRefresh(false);
      return false;
    }
    
    var PaginInfo = objJson.data.PageInfo;
    var ProductList = objJson.data.DataList;
    var nLen = ProductList.length;
    var Dom = [];
    var Info = null;
    
    if(nLen < 1){
      mui('#product_list_ifr').pullRefresh().endPullupToRefresh(true);
      return false;
    }
  
    for(var i=0; i<nLen; i++){
      Info = ProductList[i];
      
      Dom.push('<li class="mui-table-view-cell">');
      Dom.push('<div class="mui-table">');
      Dom.push('<div class="mui-table-cell mui-col-xs-12">');
      Dom.push('<p class="mui-ellipsis-2 list-title">');
      Dom.push(Info.product_name);
      Dom.push('<span class="mui-badge mui-badge-primary mui-pull-right">'+ Info.type_name +'</span>');
      Dom.push('<span class="mui-badge mui-badge-primary mui-pull-right" style="margin-right: 3px;">'+ Info.status_style +'</span>');
      Dom.push('</p>');
  
      Dom.push('<div class="hr-line-dashed"></div>');
  
      Dom.push('<div class="mui-row">');
      Dom.push('<div class="mui-col-xs-6 mui-h6">缴费方式：'+ Info.pay_type +'</div>');
      Dom.push('<div class="mui-col-xs-6 mui-h6 mui-text-right">投保年龄：'+ Info.min_age +'</div>');
      Dom.push('</div>');
  
      Dom.push('<div class="hr-line-dashed"></div>');
  
      Dom.push('<div class="mui-row">');
      Dom.push('<div class="mui-col-xs-6 mui-h6">保险期间：'+ Info.validity_year +'</div>');
      Dom.push('<div class="mui-col-xs-6 mui-h6 mui-text-right">销售数量：'+ Info.sell_number +'</div>');
      Dom.push('</div>');
  
      if(!IsN(Info.captain_first_rate)){
        Dom.push('<div class="hr-line-dashed"></div>');
  
        Dom.push('<div class="mui-row">');
        Dom.push('<div class="mui-col-xs-12 mui-h6">');
        Dom.push('<span class="mui-badge mui-badge-info">团队长提成比例</span>');
        Dom.push('</div>');
        Dom.push('<div class="mui-col-xs-6 mui-h6">首年：'+ Info.captain_first_rate +'%</div>');
        Dom.push('<div class="mui-col-xs-6 mui-h6 mui-text-right">次年：'+ Info.captain_next_rate +'%</div>');
        Dom.push('</div>');
      }
  
      Dom.push('<div class="hr-line-dashed"></div>');
  
      Dom.push('<div class="mui-row">');
      Dom.push('<div class="mui-col-xs-12 mui-h6 mui-text-center">');
      Dom.push('客户经理提成比例');
      Dom.push('</div>');
      Dom.push('<div class="mui-col-xs-6 mui-h6 mui-text-right" style="padding-right: 10px;">首年：'+ Info.member_first_rate +'%</div>');
      Dom.push('<div class="mui-col-xs-6 mui-h6 mui-text-left" style="padding-left: 10px;">次年：'+ Info.member_next_rate +'%</div>');
      Dom.push('</div>');
  
      Dom.push('<div class="hr-line-dashed"></div>');
  
      Dom.push('<div class="mui-row">');
      Dom.push('<div class="mui-col-xs-12 mui-text-center">');
      Dom.push('<a href="#account" class="mui-btn mui-btn-primary" id="look_'+ Info.id +'" data-id="'+ Info.id +'">');
      Dom.push('<span class="mui-icon iconfont icon-text"></span>&nbsp;查看详情');
      Dom.push('</a>');
  
      Dom.push('<script>');
      Dom.push('document.getElementById("look_'+ Info.id +'").addEventListener("tap", function(){');
      Dom.push('GetProductInfo(this);');
      Dom.push('});');
      Dom.push('<\/script>');
      Dom.push('</div>');
      Dom.push('</div>');
      Dom.push('</div>');
      Dom.push('</div>');
      Dom.push('</li>');
    }
    
    $('#ul_product_list').append(Dom.join(''));
    
    if(PaginInfo.more == 0){
      mui('#product_list_ifr').pullRefresh().endPullupToRefresh(true);
    }else{
      mui('#product_list_ifr').pullRefresh().endPullupToRefresh(false);
    }
  
    nCurrPage++;
  }
  //endregion 获取下一页产品
  
  //region 页面控制
  var viewApi = mui('#app').view({
    defaultPage: '#setting',
  });
  
  mui('#product_info_ifr').scroll({
    deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
  });
  
  var view = viewApi.view;
  
  (function($) {
    //处理view的后退与webview后退
    var oldBack = $.back;
    $.back = function() {
      if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
        viewApi.back();
      } else { //执行webview后退
        oldBack();
      }
    };
    //监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
    //第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
    view.addEventListener('pageBeforeShow', function(e) {
      //console.log(e.detail.page.id + ' beforeShow');
      //console.log(e);
    });
    view.addEventListener('pageShow', function(e) {
      //console.log(e.detail.page.id + ' show');
      //console.log(e);
    });
    view.addEventListener('pageBeforeBack', function(e) {
      //console.log(e.detail.page.id + ' beforeBack');
    });
    view.addEventListener('pageBack', function(e) {
      //console.log(e.detail.page.id + ' back');
    });
  })(mui);
  //endregion 页面控制
  
  //region 显示商品详情
  function GetProductInfo(obj) {
    var nProductID = $(obj).attr('data-id');
    
    $.ajax({
      type: "POST",
      url: "__URL__/AjaxProductInfo",
      dataType:"json",
      timeout: 6000,
      data: {"product_id": nProductID},
      beforeSend : function (XMLHttpRequest) {
        XMLHttpRequest.setRequestHeader("request_type","ajax");
      },
      success: function(data){
        GetProductInfoResponse(data);
      },
      error: function(request, status, error){
        //Un_BlockWindow_ExecOp();
        AlertError("请求服务器时发生错误");
      }
    });
  }
  
  function GetProductInfoResponse(objJson) {
    if(objJson.error != 0){
      //AlertError(objJson.info);
      return false;
    }
    
    if(IsN(objJson.data)){
      //AlertError("没有发现产品数据");
      return false;
    }
    
    var ProductInfo = objJson.data;
    var sStatus = "";
    var AttachmentHtml = [];
    
    $('#p_category_name').html(ProductInfo.type_name);
    $('#p_product_name').html(ProductInfo.product_name);
    $('#p_pay_type').html(ProductInfo.pay_type);
    $('#p_payment_type').html(ProductInfo.payment_type);
    $('#p_min_age').html(ProductInfo.min_age);
    $('#p_max_age').html(ProductInfo.max_age);
    $('#p_validity_year').html(ProductInfo.validity_year);
    
    if(!IsN(ProductInfo.captain_first_rate) && !IsN(ProductInfo.captain_next_rate)){
      $('#p_captain_first_rate').html(ProductInfo.captain_first_rate+"%");
      $('#p_captain_next_rate').html(ProductInfo.captain_next_rate+"%");
      $('#div_captain_rate_ifr').show();
    }
    
    $('#p_member_first_rate').html(ProductInfo.member_first_rate+"%");
    $('#p_member_next_rate').html(ProductInfo.member_next_rate+"%");
    
    
    if(ProductInfo.status == 1){
      sStatus = "已发布";
    }else{
      sStatus = "未发布";
    }
    $('#p_product_status').html(sStatus);
    $('#p_product_intro').html(ProductInfo.intro);
    $('#div_product_desc').html(ProductInfo.content);
    $('#p_product_remark').html(ProductInfo.remarks);
    
    if(!IsN(ProductInfo.attachment)){
      switch(ProductInfo.attachment_type){
        case "image":
          AttachmentHtml.push('<div class="file-box">');
          AttachmentHtml.push('<div class="file">');
          AttachmentHtml.push('<a href="__MODULE__/Download/OriginalNameImage/image_id/'+ ProductInfo.attachment.id +'">');
          AttachmentHtml.push('<span class="corner"></span>');
          AttachmentHtml.push('<div class="image">');
          AttachmentHtml.push('<img alt="image" class="img-responsive" src="'+ ProductInfo.attachment.full_file +'">');
          AttachmentHtml.push('</div>');
          AttachmentHtml.push('<div class="file-name">');
          AttachmentHtml.push(ProductInfo.attachment.original_name);
          AttachmentHtml.push('<br/>');
          AttachmentHtml.push('<small>添加时间：'+ ProductInfo.attachment.add_date +'</small>');
          AttachmentHtml.push('</div>');
          AttachmentHtml.push('</a>');
          AttachmentHtml.push('</div>');
          AttachmentHtml.push('</div>');
          break;
        
        case "file":
          AttachmentHtml.push('<div class="file-box">');
          AttachmentHtml.push('<div class="file">');
          AttachmentHtml.push('<a href="__MODULE__/Download/OriginalNameFile/file_id/'+ ProductInfo.attachment.id +'">');
          AttachmentHtml.push('<span class="corner"></span>');
          AttachmentHtml.push('<div class="icon">');
          AttachmentHtml.push('<i class="fa '+ ProductInfo.attachment.icon +'"></i>');
          AttachmentHtml.push('</div>');
          AttachmentHtml.push('<div class="file-name">');
          AttachmentHtml.push(ProductInfo.attachment.original_name);
          AttachmentHtml.push('<br/>');
          AttachmentHtml.push('<small>文件大小：'+ ProductInfo.attachment.icon +'KB</small>');
          AttachmentHtml.push('<br/>');
          AttachmentHtml.push('<small>添加时间：'+ ProductInfo.attachment.add_date +'</small>');
          AttachmentHtml.push('</div>');
          AttachmentHtml.push('</a>');
          AttachmentHtml.push('</div>');
          AttachmentHtml.push('</div>');
          break;
      }
    }
    
    $('#div_attachment').html(AttachmentHtml.join(''));
    
    //ShowProductInfo();
  }
  //endregion 显示商品详情
</script>
